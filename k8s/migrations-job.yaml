# ===========================================
# Database Migrations Job
# ===========================================
# Job separado para executar migrations do banco
# Imagem: fishing-map-migrations (projeto separado)
# ===========================================

apiVersion: batch/v1
kind: Job
metadata:
  name: db-migrations
  namespace: fishing-map
  labels:
    app: migrations
    component: database-setup
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 600
  template:
    metadata:
      labels:
        app: migrations
        component: database-setup
    spec:
      restartPolicy: OnFailure
      imagePullSecrets:
      - name: registry-secret

      initContainers:
      # Aguardar o banco estar pronto antes de executar migrations
      - name: wait-for-database
        image: postgres:15-alpine
        command:
        - sh
        - -c
        - |
          echo "â³ Aguardando banco de dados ficar disponÃ­vel..."
          until pg_isready -h $DB_HOST -p $DB_PORT -U $DB_USER; do
            echo "   Banco ainda nÃ£o estÃ¡ pronto, aguardando..."
            sleep 3
          done
          echo "âœ“ Banco de dados estÃ¡ pronto!"
        env:
        - name: DB_HOST
          valueFrom:
            secretKeyRef:
              name: fishing-map-secrets
              key: DB_HOST
        - name: DB_PORT
          valueFrom:
            secretKeyRef:
              name: fishing-map-secrets
              key: DB_PORT
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: fishing-map-secrets
              key: DB_USER
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: fishing-map-secrets
              key: DB_PASSWORD

      containers:
      - name: migrations
        image: registry.digitalocean.com/fishing-map/migrations:latest
        imagePullPolicy: Always
        env:
        - name: NODE_ENV
          value: "production"
        - name: DB_HOST
          valueFrom:
            secretKeyRef:
              name: fishing-map-secrets
              key: DB_HOST
        - name: DB_PORT
          valueFrom:
            secretKeyRef:
              name: fishing-map-secrets
              key: DB_PORT
        - name: DB_NAME
          valueFrom:
            secretKeyRef:
              name: fishing-map-secrets
              key: DB_NAME
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: fishing-map-secrets
              key: DB_USER
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: fishing-map-secrets
              key: DB_PASSWORD
        command:
        - sh
        - -c
        - |
          set -e
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”§ Iniciando Migrations do Banco de Dados"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          echo "ğŸ“Š Verificando status das migrations..."
          npm run migrate:status || true
          
          echo ""
          echo "ğŸš€ Executando migrations pendentes..."
          npm run migrate:up
          
          echo ""
          echo "ğŸ—ºï¸  Configurando extensÃ£o PostGIS..."
          npm run setup:postgis || true
          
          echo ""
          echo "ğŸŒ± Executando seeds de produÃ§Ã£o..."
          npm run seed:production || true
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Migrations concluÃ­das com sucesso!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "250m"

---
# ===========================================
# CronJob para VerificaÃ§Ã£o PeriÃ³dica
# ===========================================
# Verifica e aplica novas migrations automaticamente
# ===========================================

apiVersion: batch/v1
kind: CronJob
metadata:
  name: db-migrations-check
  namespace: fishing-map
  labels:
    app: migrations
    component: periodic-check
spec:
  schedule: "0 6 * * 1" # Toda segunda-feira Ã s 6h
  suspend: false
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      ttlSecondsAfterFinished: 1800
      template:
        metadata:
          labels:
            app: migrations
            component: periodic-check
        spec:
          restartPolicy: OnFailure
          imagePullSecrets:
          - name: registry-secret
          containers:
          - name: migrations-check
            image: registry.digitalocean.com/fishing-map/migrations:latest
            imagePullPolicy: Always
            env:
            - name: NODE_ENV
              value: "production"
            - name: DB_HOST
              valueFrom:
                secretKeyRef:
                  name: fishing-map-secrets
                  key: DB_HOST
            - name: DB_PORT
              valueFrom:
                secretKeyRef:
                  name: fishing-map-secrets
                  key: DB_PORT
            - name: DB_NAME
              valueFrom:
                secretKeyRef:
                  name: fishing-map-secrets
                  key: DB_NAME
            - name: DB_USER
              valueFrom:
                secretKeyRef:
                  name: fishing-map-secrets
                  key: DB_USER
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: fishing-map-secrets
                  key: DB_PASSWORD
            command:
            - sh
            - -c
            - |
              set -e
              echo "ğŸ” Verificando migrations pendentes..."
              npm run migrate:status
              
              echo ""
              echo "ğŸ”„ Aplicando migrations pendentes (se houver)..."
              npm run migrate:up
              
              echo ""
              echo "âœ… VerificaÃ§Ã£o de migrations concluÃ­da!"
            resources:
              requests:
                memory: "128Mi"
                cpu: "50m"
              limits:
                memory: "256Mi"
                cpu: "100m"
