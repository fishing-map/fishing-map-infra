{{- if .Values.sonarqube.enabled }}
{{- if .Values.sonarqube.storage.data.enabled }}
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: sonarqube-postgres-pvc
  namespace: {{ .Values.namespace }}
  labels:
    app: sonarqube-postgres
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 2Gi
  storageClassName: {{ .Values.sonarqube.storage.data.storageClassName }}
---
{{- end }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sonarqube-postgres
  namespace: {{ .Values.namespace }}
  labels:
    app: sonarqube-postgres
    {{- include "fishing-map-infrastructure.labels" . | nindent 4 }}
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: sonarqube-postgres
  template:
    metadata:
      labels:
        app: sonarqube-postgres
    spec:
      containers:
        - name: postgres
          image: "{{ .Values.sonarqube.postgres.image.repository }}:{{ .Values.sonarqube.postgres.image.tag }}"
          ports:
            - containerPort: 5432
          env:
            - name: POSTGRES_DB
              value: "{{ .Values.sonarqube.postgres.database }}"
            - name: POSTGRES_USER
              value: "{{ .Values.sonarqube.postgres.user }}"
            - name: POSTGRES_PASSWORD
              value: "{{ .Values.sonarqube.postgres.password }}"
            - name: PGDATA
              value: "/var/lib/postgresql/data/pgdata"
          volumeMounts:
            - name: postgres-storage
              mountPath: /var/lib/postgresql/data
          livenessProbe:
            exec:
              command:
                - pg_isready
                - -U
                - {{ .Values.sonarqube.postgres.user }}
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            exec:
              command:
                - pg_isready
                - -U
                - {{ .Values.sonarqube.postgres.user }}
            initialDelaySeconds: 15
            periodSeconds: 5
          resources:
            {{- toYaml .Values.sonarqube.postgres.resources | nindent 12 }}
      volumes:
        - name: postgres-storage
          {{- if .Values.sonarqube.storage.data.enabled }}
          persistentVolumeClaim:
            claimName: sonarqube-postgres-pvc
          {{- else }}
          emptyDir: {}
          {{- end }}
---
apiVersion: v1
kind: Service
metadata:
  name: sonarqube-postgres-service
  namespace: {{ .Values.namespace }}
  labels:
    app: sonarqube-postgres
spec:
  type: ClusterIP
  ports:
    - port: 5432
      targetPort: 5432
  selector:
    app: sonarqube-postgres
---
{{- if .Values.sonarqube.storage.data.enabled }}
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: sonarqube-data-pvc
  namespace: {{ .Values.namespace }}
  labels:
    app: sonarqube
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: {{ .Values.sonarqube.storage.data.size }}
  storageClassName: {{ .Values.sonarqube.storage.data.storageClassName }}
---
{{- end }}
{{- if .Values.sonarqube.storage.extensions.enabled }}
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: sonarqube-extensions-pvc
  namespace: {{ .Values.namespace }}
  labels:
    app: sonarqube
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: {{ .Values.sonarqube.storage.extensions.size }}
  storageClassName: {{ .Values.sonarqube.storage.extensions.storageClassName }}
---
{{- end }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sonarqube
  namespace: {{ .Values.namespace }}
  labels:
    app: sonarqube
    {{- include "fishing-map-infrastructure.labels" . | nindent 4 }}
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: sonarqube
  template:
    metadata:
      labels:
        app: sonarqube
    spec:
      securityContext:
        fsGroup: 1000
      initContainers:
        # Wait for postgres to be ready
        - name: wait-for-postgres
          image: busybox:1.36
          command: ['sh', '-c', 'until nc -z sonarqube-postgres-service 5432; do echo "Waiting for postgres..."; sleep 2; done; echo "Postgres is ready!"']
          resources:
            requests:
              memory: "32Mi"
              cpu: "10m"
            limits:
              memory: "64Mi"
              cpu: "50m"
        # Fix permissions for SonarQube directories
        - name: init-permissions
          image: busybox:1.36
          command: ['sh', '-c', 'chown -R 1000:1000 /opt/sonarqube/data /opt/sonarqube/extensions /opt/sonarqube/logs || true']
          volumeMounts:
            - name: sonarqube-data
              mountPath: /opt/sonarqube/data
            - name: sonarqube-extensions
              mountPath: /opt/sonarqube/extensions
            - name: sonarqube-logs
              mountPath: /opt/sonarqube/logs
          securityContext:
            runAsUser: 0
          resources:
            requests:
              memory: "32Mi"
              cpu: "10m"
            limits:
              memory: "64Mi"
              cpu: "50m"
      containers:
        - name: sonarqube
          image: "{{ .Values.sonarqube.image.repository }}:{{ .Values.sonarqube.image.tag }}"
          imagePullPolicy: {{ .Values.sonarqube.image.pullPolicy }}
          ports:
            - containerPort: 9000
              name: http
          env:
            - name: SONAR_JDBC_URL
              value: "jdbc:postgresql://sonarqube-postgres-service:5432/{{ .Values.sonarqube.postgres.database }}"
            - name: SONAR_JDBC_USERNAME
              value: "{{ .Values.sonarqube.postgres.user }}"
            - name: SONAR_JDBC_PASSWORD
              value: "{{ .Values.sonarqube.postgres.password }}"
            - name: SONAR_ES_BOOTSTRAP_CHECKS_DISABLE
              value: "true"
            - name: SONAR_WEB_JAVAOPTS
              value: "{{ .Values.sonarqube.javaOpts.web }}"
            - name: SONAR_CE_JAVAOPTS
              value: "{{ .Values.sonarqube.javaOpts.ce }}"
            - name: SONAR_SEARCH_JAVAOPTS
              value: "{{ .Values.sonarqube.javaOpts.search }}"
          volumeMounts:
            - name: sonarqube-data
              mountPath: /opt/sonarqube/data
            - name: sonarqube-extensions
              mountPath: /opt/sonarqube/extensions
            - name: sonarqube-logs
              mountPath: /opt/sonarqube/logs
          resources:
            {{- toYaml .Values.sonarqube.resources | nindent 12 }}
          livenessProbe:
            httpGet:
              path: /api/system/status
              port: 9000
            initialDelaySeconds: 180
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 6
          readinessProbe:
            httpGet:
              path: /api/system/status
              port: 9000
            initialDelaySeconds: 90
            periodSeconds: 15
            timeoutSeconds: 10
            failureThreshold: 6
          startupProbe:
            httpGet:
              path: /api/system/status
              port: 9000
            initialDelaySeconds: 60
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 30
      volumes:
        - name: sonarqube-data
          {{- if .Values.sonarqube.storage.data.enabled }}
          persistentVolumeClaim:
            claimName: sonarqube-data-pvc
          {{- else }}
          emptyDir: {}
          {{- end }}
        - name: sonarqube-extensions
          {{- if .Values.sonarqube.storage.extensions.enabled }}
          persistentVolumeClaim:
            claimName: sonarqube-extensions-pvc
          {{- else }}
          emptyDir: {}
          {{- end }}
        - name: sonarqube-logs
          emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: sonarqube-service
  namespace: {{ .Values.namespace }}
  labels:
    app: sonarqube
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 9000
      targetPort: 9000
  selector:
    app: sonarqube
---
{{- if .Values.sonarqube.ingress.enabled }}
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: sonarqube-ingress
  namespace: {{ .Values.namespace }}
  labels:
    app: sonarqube
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/proxy-body-size: "100m"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
spec:
  ingressClassName: {{ .Values.sonarqube.ingress.className }}
  {{- if .Values.sonarqube.ingress.tls.enabled }}
  tls:
    - hosts:
        - {{ .Values.sonarqube.ingress.host }}
      secretName: {{ .Values.sonarqube.ingress.tls.secretName }}
  {{- end }}
  rules:
    - host: {{ .Values.sonarqube.ingress.host }}
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: sonarqube-service
                port:
                  number: 9000
{{- end }}
{{- end }}

