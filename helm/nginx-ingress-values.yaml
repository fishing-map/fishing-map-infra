# Nginx Ingress Controller values
# This file is used by the pipeline to install nginx-ingress via Helm
# Usage: helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx -f nginx-ingress-values.yaml

controller:
  ingressClassResource:
    default: true
    name: nginx

  publishService:
    enabled: true

  service:
    type: LoadBalancer
    externalTrafficPolicy: Local
    annotations:
      service.beta.kubernetes.io/do-loadbalancer-name: "fishing-map-nginx-lb"
      service.beta.kubernetes.io/do-loadbalancer-protocol: "http"
      service.beta.kubernetes.io/do-loadbalancer-size-slug: "lb-small"

  config:
    use-forwarded-headers: "true"
    compute-full-forwarded-for: "true"
    use-proxy-protocol: "false"
    enable-real-ip: "true"
    proxy-real-ip-cidr: "0.0.0.0/0"

    proxy-body-size: "100m"
    client-max-body-size: "100m"
    client-body-buffer-size: "8k"
    client-header-buffer-size: "1k"
    large-client-header-buffers: "4 8k"

    proxy-connect-timeout: "75"
    proxy-send-timeout: "75"
    proxy-read-timeout: "75"

    ssl-protocols: "TLSv1.2 TLSv1.3"
    ssl-prefer-server-ciphers: "true"
    ssl-ciphers: "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384"

    worker-processes: "auto"
    max-worker-connections: "16384"
    upstream-keepalive-connections: "320"
    upstream-keepalive-timeout: "60"
    keep-alive: "75"
    keep-alive-requests: "1000"

    server-tokens: "false"
    hide-headers: "X-Powered-By,Server"

    allow-snippet-annotations: "true"

    log-format-upstream: '$remote_addr - $remote_user [$time_local] "$request" $status $body_bytes_sent "$http_referer" "$http_user_agent" $request_length $request_time [$proxy_upstream_name] [$proxy_alternative_upstream_name] $upstream_addr $upstream_response_length $upstream_response_time $upstream_status $req_id $host'

  metrics:
    enabled: true
    serviceMonitor:
      enabled: false
    service:
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "10254"

  podAnnotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "10254"

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

  autoscaling:
    enabled: true
    minReplicas: 1
    maxReplicas: 2
    targetCPUUtilizationPercentage: 80
    targetMemoryUtilizationPercentage: 80

  livenessProbe:
    httpGet:
      path: /healthz
      port: 10254
      scheme: HTTP
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 1
    successThreshold: 1
    failureThreshold: 5

  readinessProbe:
    httpGet:
      path: /healthz
      port: 10254
      scheme: HTTP
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 1
    successThreshold: 1
    failureThreshold: 3

