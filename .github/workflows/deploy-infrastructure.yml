name: Deploy Infrastructure Components

on:
  workflow_dispatch:
    inputs:
      component:
        type: choice
        options: [all, redis, pgadmin, sonarqube, observability, secrets-only]
        default: all
        description: "Component to deploy"
      action:
        type: choice
        options: [install, uninstall, template]
        default: install
        description: "Action to perform"
      enable_observability:
        type: boolean
        default: false
        description: "Enable observability stack (Prometheus, Grafana, Loki, Jaeger)"

env:
  K8S_NAMESPACE: fishing-map
  K8S_CLUSTER_NAME: fishing-map-prod-cluster

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: prod

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_TOKEN }}

      - name: Configure kubectl
        run: |
          doctl kubernetes cluster kubeconfig save ${{ env.K8S_CLUSTER_NAME }}
          kubectl get nodes

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.14.0'

      - name: Ensure namespace exists
        if: ${{ github.event.inputs.action != 'template' }}
        run: |
          kubectl get namespace ${{ env.K8S_NAMESPACE }} || kubectl create namespace ${{ env.K8S_NAMESPACE }}

      - name: Create/Update registry secret
        if: ${{ github.event.inputs.action == 'install' }}
        run: |
          doctl registry login --expiry-seconds 600
          
          kubectl delete secret registry-secret -n ${{ env.K8S_NAMESPACE }} --ignore-not-found=true
          kubectl create secret docker-registry registry-secret \
            --docker-server=registry.digitalocean.com \
            --docker-username=${{ secrets.DIGITALOCEAN_TOKEN }} \
            --docker-password=${{ secrets.DIGITALOCEAN_TOKEN }} \
            -n ${{ env.K8S_NAMESPACE }}

      - name: Build Helm values
        id: helm-values
        run: |
          COMPONENT="${{ github.event.inputs.component }}"
          ENABLE_OBS="${{ github.event.inputs.enable_observability }}"
          
          HELM_SETS=""
          
          # Always set secrets
          HELM_SETS="$HELM_SETS --set secrets.enabled=true"
          HELM_SETS="$HELM_SETS --set secrets.database.host=${{ secrets.DB_HOST }}"
          HELM_SETS="$HELM_SETS --set secrets.database.port=${{ secrets.DB_PORT }}"
          HELM_SETS="$HELM_SETS --set secrets.database.name=${{ secrets.DB_NAME }}"
          HELM_SETS="$HELM_SETS --set secrets.database.user=${{ secrets.DB_USER }}"
          HELM_SETS="$HELM_SETS --set secrets.database.password=${{ secrets.DB_PASSWORD }}"
          HELM_SETS="$HELM_SETS --set secrets.redis.password=${{ secrets.REDIS_PASSWORD }}"
          HELM_SETS="$HELM_SETS --set secrets.jwt.secret=${{ secrets.JWT_SECRET }}"
          HELM_SETS="$HELM_SETS --set secrets.jwt.refreshSecret=${{ secrets.REFRESH_TOKEN_SECRET }}"
          HELM_SETS="$HELM_SETS --set secrets.weather.apiKey=${{ secrets.API_KEY_WEATHER }}"
          HELM_SETS="$HELM_SETS --set secrets.spaces.accessKey=${{ secrets.SPACES_ACCESS_KEY }}"
          HELM_SETS="$HELM_SETS --set secrets.spaces.secretKey=${{ secrets.SPACES_SECRET_KEY }}"
          HELM_SETS="$HELM_SETS --set secrets.spaces.endpoint=${{ secrets.SPACES_ENDPOINT }}"
          HELM_SETS="$HELM_SETS --set secrets.spaces.bucket=${{ secrets.SPACES_BUCKET }}"
          HELM_SETS="$HELM_SETS --set secrets.spaces.region=${{ secrets.SPACES_REGION }}"
          HELM_SETS="$HELM_SETS --set secrets.spaces.cdnUrl=${{ secrets.SPACES_CDN_URL }}"
          
          # Component-specific settings
          if [ "$COMPONENT" == "all" ]; then
            HELM_SETS="$HELM_SETS --set redis.enabled=true"
            HELM_SETS="$HELM_SETS --set pgadmin.enabled=true"
            HELM_SETS="$HELM_SETS --set sonarqube.enabled=true"
          elif [ "$COMPONENT" == "redis" ]; then
            HELM_SETS="$HELM_SETS --set redis.enabled=true"
            HELM_SETS="$HELM_SETS --set pgadmin.enabled=false"
            HELM_SETS="$HELM_SETS --set sonarqube.enabled=false"
          elif [ "$COMPONENT" == "pgadmin" ]; then
            HELM_SETS="$HELM_SETS --set redis.enabled=false"
            HELM_SETS="$HELM_SETS --set pgadmin.enabled=true"
            HELM_SETS="$HELM_SETS --set sonarqube.enabled=false"
          elif [ "$COMPONENT" == "sonarqube" ]; then
            HELM_SETS="$HELM_SETS --set redis.enabled=false"
            HELM_SETS="$HELM_SETS --set pgadmin.enabled=false"
            HELM_SETS="$HELM_SETS --set sonarqube.enabled=true"
          elif [ "$COMPONENT" == "observability" ]; then
            HELM_SETS="$HELM_SETS --set redis.enabled=false"
            HELM_SETS="$HELM_SETS --set pgadmin.enabled=false"
            HELM_SETS="$HELM_SETS --set sonarqube.enabled=false"
            HELM_SETS="$HELM_SETS --set observability.enabled=true"
            HELM_SETS="$HELM_SETS --set ingress.devtools.enabled=true"
          elif [ "$COMPONENT" == "secrets-only" ]; then
            HELM_SETS="$HELM_SETS --set redis.enabled=false"
            HELM_SETS="$HELM_SETS --set pgadmin.enabled=false"
            HELM_SETS="$HELM_SETS --set sonarqube.enabled=false"
          fi
          
          # PgAdmin specific
          if [ "$COMPONENT" == "all" ] || [ "$COMPONENT" == "pgadmin" ]; then
            HELM_SETS="$HELM_SETS --set pgadmin.adminPassword=${{ secrets.PGADMIN_PASSWORD }}"
            HELM_SETS="$HELM_SETS --set pgadmin.database.host=${{ secrets.DB_HOST }}"
            HELM_SETS="$HELM_SETS --set pgadmin.database.port=${{ secrets.DB_PORT }}"
            HELM_SETS="$HELM_SETS --set pgadmin.database.user=${{ secrets.DB_USER }}"
          fi
          
          # Observability
          if [ "$ENABLE_OBS" == "true" ] || [ "$COMPONENT" == "observability" ]; then
            HELM_SETS="$HELM_SETS --set observability.enabled=true"
            HELM_SETS="$HELM_SETS --set ingress.devtools.enabled=true"
          fi
          
          echo "helm_sets=$HELM_SETS" >> $GITHUB_OUTPUT

      - name: Template (dry-run)
        if: ${{ github.event.inputs.action == 'template' }}
        run: |
          echo "Generating Helm template..."
          helm template fishing-map-infra ./helm \
            --namespace ${{ env.K8S_NAMESPACE }} \
            ${{ steps.helm-values.outputs.helm_sets }}

      - name: Deploy Infrastructure with Helm
        if: ${{ github.event.inputs.action == 'install' }}
        run: |
          echo "Deploying with Helm..."
          echo "Component: ${{ github.event.inputs.component }}"
          
          helm upgrade --install fishing-map-infra ./helm \
            --namespace ${{ env.K8S_NAMESPACE }} \
            ${{ steps.helm-values.outputs.helm_sets }} \
            --wait \
            --timeout 10m

      - name: Uninstall Infrastructure
        if: ${{ github.event.inputs.action == 'uninstall' }}
        run: |
          echo "Uninstalling fishing-map-infra..."
          helm uninstall fishing-map-infra --namespace ${{ env.K8S_NAMESPACE }} || true

      - name: Verify deployment
        if: ${{ github.event.inputs.action == 'install' }}
        run: |
          echo "=== Helm Release ==="
          helm list -n ${{ env.K8S_NAMESPACE }}
          echo ""
          echo "=== Secrets ==="
          kubectl get secrets -n ${{ env.K8S_NAMESPACE }}
          echo ""
          echo "=== ConfigMaps ==="
          kubectl get configmaps -n ${{ env.K8S_NAMESPACE }}
          echo ""
          echo "=== Deployments ==="
          kubectl get deployments -n ${{ env.K8S_NAMESPACE }}
          echo ""
          echo "=== Pods ==="
          kubectl get pods -n ${{ env.K8S_NAMESPACE }}
          echo ""
          echo "=== Services ==="
          kubectl get svc -n ${{ env.K8S_NAMESPACE }}
          echo ""
          echo "=== Ingresses ==="
          kubectl get ingress -n ${{ env.K8S_NAMESPACE }}
          echo ""
          echo "=== PVCs ==="
          kubectl get pvc -n ${{ env.K8S_NAMESPACE }}

      - name: Summary
        if: success()
        run: |
          echo "## Infrastructure Deploy Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Component: ${{ github.event.inputs.component }}" >> $GITHUB_STEP_SUMMARY
          echo "### Action: ${{ github.event.inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Access URLs:" >> $GITHUB_STEP_SUMMARY
          echo "- PgAdmin: https://pgadmin.fishingmap.com.br" >> $GITHUB_STEP_SUMMARY
          echo "- SonarQube: https://sonar.fishingmap.com.br" >> $GITHUB_STEP_SUMMARY
          echo "- Grafana: https://grafana.fishingmap.com.br" >> $GITHUB_STEP_SUMMARY
          echo "- Prometheus: https://prometheus.fishingmap.com.br" >> $GITHUB_STEP_SUMMARY
          echo "- Jaeger: https://jaeger.fishingmap.com.br" >> $GITHUB_STEP_SUMMARY

