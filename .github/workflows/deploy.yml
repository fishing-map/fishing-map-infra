name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      component:
        type: choice
        options: [none, all, redis, pgadmin, sonarqube, observability]
        default: none
        description: "Component to deploy (none = only check status)"

env:
  CLUSTER_NAME: fishing-map-prod-cluster
  NAMESPACE: fishing-map
  RELEASE_NAME: fishing-map-infra

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: prod

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup DigitalOcean
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_TOKEN }}

      - name: Configure kubectl
        run: |
          doctl kubernetes cluster kubeconfig save ${{ env.CLUSTER_NAME }}
          kubectl get nodes

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Show Current Status
        run: |
          echo "=== Helm Releases ==="
          helm list -n ${{ env.NAMESPACE }} || true
          echo ""
          echo "=== Pods ==="
          kubectl get pods -n ${{ env.NAMESPACE }} || true
          echo ""
          echo "=== Ingresses ==="
          kubectl get ingress -n ${{ env.NAMESPACE }} || true

      - name: Deploy Helm Chart
        if: ${{ inputs.component != 'none' }}
        run: |
          COMPONENT="${{ inputs.component }}"
          
          HELM_ARGS="--namespace ${{ env.NAMESPACE }} --skip-crds"
          
          case "$COMPONENT" in
            all)
              HELM_ARGS="$HELM_ARGS --set redis.enabled=true"
              HELM_ARGS="$HELM_ARGS --set pgadmin.enabled=false"
              HELM_ARGS="$HELM_ARGS --set sonarqube.enabled=false"
              HELM_ARGS="$HELM_ARGS --set observability.enabled=false"
              HELM_ARGS="$HELM_ARGS --set ingress.devtools.enabled=false"
              ;;
            redis)
              HELM_ARGS="$HELM_ARGS --set redis.enabled=true"
              ;;
            pgadmin)
              HELM_ARGS="$HELM_ARGS --set pgadmin.enabled=true"
              ;;
            sonarqube)
              HELM_ARGS="$HELM_ARGS --set sonarqube.enabled=true"
              ;;
            observability)
              HELM_ARGS="$HELM_ARGS --set observability.enabled=true"
              ;;
          esac
          
          echo "Deploying: $COMPONENT"
          helm upgrade --install ${{ env.RELEASE_NAME }} ./helm $HELM_ARGS --wait --timeout 10m

      - name: Skip Deploy Info
        if: ${{ inputs.component == 'none' }}
        run: echo "Status check only - no deployment requested"

